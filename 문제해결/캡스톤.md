## 도커

***

### 문제점

Docker Swarm을 이용하려고 했는데 노드 간 통신이 이뤄지지 않았음.

### 원인

도커 Network 설정을 출력해보니 노드들이 Private IP로 네트워크에 속해 있었음.

### 해결책

init과 join 과정에서 --advertise-addr를 통해 서버의 Public IP를 명시해줘야 한다.

### 여담

AWS만의 문제인 건지? 혹은 애초에 AWS에서 Private IP와 Public IP를 어떻게 매칭시키는지?

컴퓨터 네트워크 공부를 다시 해야할 듯

***

### 문제점

서비스 IP로는 요청/응답이 정상적으로 이뤄지는 것 같은데, 서비스 IP가 컨테이너 IP로 resolve되지 않는 것처럼 보임.

따라서 노드 간 통신이 제대로 이뤄지지 않았음.

### 원인

도커 Overlay 네크워크의 encryption 옵션을 끄니까 접속이 잘 되었음.

근본적인 원인이 뭔지는 아직 파악하지 못함. 방화벽 설정도 테스트 해봤는데 원인을 찾지 못함.

커널 업데이트를 해서 해결되었다는 인터넷 정보를 찾음. 시도해 볼 예정

* 시도해봤는데 해결되지 않음.

또한 IPSec 프로토콜에 대한 테스트도 진행해봤는데, E

### 해결책

### 여담

***

### 문제점

도커 서비스가 시작되지 않는데, 로그를 확인할 수 없음

### 해결책

```bash
docker service ps --no-trunc {serviceName}
```

위 명령어 이용

### 문제점

도커 private 저장소에 이미지를 push 하는데, https 연결이 시도되며 실패함

### 해결책

```bash
/etc/docker/daemon.json

{
  "insecure-registries" : ["climateprediction.xyz:5000"]
}
```

위 경로에 해당 내용 입력

***

### 문제점

서버의 방화벽을 설정하던 중 도커 네트워크가 잘 작동하지 않았다.

### 원인

기존의 노드 연결이 끊어지고 자동으로 재연결이  수행되지 않았던 것 같음.

### 해결책

도커 스웜에 재가입하여 해결

### 여담

재가입 대신 재연결할 수 있는 방법이 있나 찾아보자.

---

### 문제점

젠킨스 빌드 중 오류가 나서 컨테이너를 재시작 했더니 오류가 발생하며 실행이 되지 않았다.

### 원인

```bash
# 파일 시스템의 총 공간 및 사용 가능한 공간에 대한 정보 표시
df -h
# 도커 용량 확인 (옵션을 주면 자세하게 출력)
docker system df --verbose
```

도커 캐시가 지워지지 않고 계속 쌓여 디스크 공간이 거의 전부 사용 중이었다..

### 해결책

도커 캐시를 지우는 작업을 스케줄러에 등록하였다.

### 여담

젠킨스 빌드 과정에서 생긴 캐시도 지우는 플러그인도 설치하였다.

***

## 젠킨스

***

### 문제점

젠킨스를 통한 도커 이미지 빌드 과정에서 서버가 먹통이 되고 결국 빌드가 중단되는 오류 발생

### 원인

SSH로 서버에 접속하여 랙이 걸리는 상황에서 free -h 명령어를 통해 메모리 사용량을 확인했더니

서버의 2GB 메모리를 거의 전부 사용하고 있었음. 

### 해결책

스왑 메모리를 설정해보자.
```bash
# 기존 swapfile 삭제
sudo swapoff /swapfile
sudo rm /swapfile
# 새로운 swapfile 생성 및 등록
sudo fallocate -l 4G /swapfile 
sudo chmod 600 /swapfile 
sudo mkswap /swapfile 
sudo swapon /swapfile 
sudo bash -c 'echo "/swapfile swap swap defaults 0 0" >> /etc/fstab' 
sudo swapon --show 
free -h
```

위를 통해 4GB의 스왑 메모리를 생성할 수 있다.

### 여담

free -h의 출력 결과가 정확히 어떤 의미인지 알아둘 필요가 있어 보인다.

* total = 전체 메모리
* used = 현재 사용중인 메모리
* free = 할당되지 않은 메모리
* shared = 공유 메모리 (IPC / 공유 라이브러리)
* buffer/cache = 버퍼와 캐싱 용도로 사용하는 메모리
* available = free + buffer/cache

buffer 메모리와 cache 메모리의 차이

* buffer
  * I/O 작업을 수월하게 하기 위해 이용됨.
  * 가령 로그를 파일에 기록하는 프로세스가 있다고 생각해보자.
  * 매번 Disk에 로그를 기록하게 되면 속도가 굉장히 느릴 것이다.
  * 따라서 RAM에 로그를 기록하면 OS가 주기적으로 데이터를 Disk에 써준다.
* cache
  * 참조 지역성에 따라 데이터를 RAM에 적재한다.

또한 free의 결과로는 buffer/cache가 한번에 출력되지만, vmstat으로 각각 확인할 수 있다. 직접 확인해봤는데 현재 I/O 작업이 적게 이뤄지고 있어서인지, buffer보다는 cache 메모리의 비중이 훨씬 높았다.

***

### 문제점

Host의 도커 socket 파일을 젠킨스 컨테이너에서 공유할 때 권한 오류가 발생

### 원인

젠킨스 컨테이너 내부에서 확인해보니 docker.sock 파일의 그룹이 systemd-journal로 표시되고 있음

### 해결책

젠킨스 컨테이너 실행 시 jenkins 유저를 systemd-journal 그룹에 추가했더니 정상적으로 작동함

### 여담

도커의 작동 원리에 대해 정확히 알 필요가 있을 듯

***

## SSHFS

***

### 문제점

마운트를 했는데 잘 안 됨 (나중에 적는 거라 기억이 잘 안남)

### 원인

권한 관련 오류

### 해결책

allow_other 플래그를 줘서 마운트

```bash
sudo sshfs -o IdentityFile=~/.ssh/개인키,allow_other 유저@원격IP:원격디렉토리 호스트디렉토리
```

* 띄어쓰기에 유의할 것